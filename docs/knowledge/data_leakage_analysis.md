# データリーク分析と対策

最終更新日: 2025-07-19

## 概要

NeurIPS Open Polymer Prediction 2025コンペティションにおいて、テストデータと公開データソースの間に重大なデータリークが発見されました。本文書では、リークの詳細、影響、およびコンペティション主催者の対応について整理します。

## データリークの発見

### 1. リークの内容

外部の公開データソースから取得可能なポリマーデータが、隠されているはずのテストセットに含まれていることが判明しました。

**影響を受けた外部データソース：**
- `dmitryuarov/smiles-extra-data`（Kaggle Dataset）
  - BigSMILES形式のポリマーデータ
  - Tg（ガラス転移温度）データ
  - Density（密度）データ
- `minatoyukinaxlisa/tc-smiles`（Kaggle Dataset）
  - Tc（結晶化温度）データ

### 2. リークの検証コード

```python
# neurips-baseline-external-dataノートブックより
for t in CFG.TARGETS:
    for s in train[train[t].notnull()]['SMILES']:
        if s in test['SMILES'].tolist():
            test.loc[test['SMILES']==s, t] = train[train['SMILES']==s][t].values[0]
```

このコードにより、外部データのSMILESがテストデータに含まれている場合、ラベルを直接転写できることが実証されました。

## リークの影響

### 1. リーダーボードの信頼性低下

- **Public LBスコアの過大評価**
  - データリークを利用した解法が高スコアを獲得
  - 実際の汎化性能を反映していない

- **大規模なシェイクの予想**
  - Private testでリーク部分が除外される可能性
  - 外部データ依存の解法は大幅に順位を落とす

### 2. 競技の公平性への影響

- 外部データを知っている参加者が有利
- 純粋なモデリング能力の評価が困難

## コンペティション主催者の対応（公式発表）

### 1. データセットの更新

**新しい訓練データの追加：**
- `dataset1.csv` - ホストの古いシミュレーション結果からのTcデータ
- `dataset2.csv` - Tgテーブルからの SMILESリスト（実験値であり、コンペのシミュレーション値とは異なる）
- `dataset3.csv` - ホストの古いシミュレーション結果
- `dataset4.csv` - ホストの古いシミュレーション結果

### 2. テストセットの改修

- **影響を受けた行の削除**
  - リークが確認されたデータをテストセットから除外

- **新規データの追加**
  - 約3,000個の新しいポリマーを追加（合計約3,500個）
  - 新規データの生成には約2ヶ月必要

### 3. スコアリングの変更

- 既存の提出物は再推論される
- 新しいポリマーのラベルが準備できるまでスコアリングされない
- ラベル準備後、全ての提出物が再スコアリングされる

## 推奨される対策

### 1. 保守的なアプローチ

```python
# コンペティションデータのみを使用
train_competition = pd.read_csv('train.csv')
# 外部データは使用しない、または慎重に検証
```

### 2. 堅牢性の重視

- **クロスバリデーション戦略の強化**
  - GroupKFoldの使用
  - 時系列分割の検討
  
- **アンサンブル手法**
  - 複数のモデルアーキテクチャ
  - 異なる特徴量セット

### 3. 汎化性能の評価

```python
# リーク部分を除外した検証
def validate_without_leakage(train, test):
    # テストデータに含まれるSMILESを除外
    train_filtered = train[~train['SMILES'].isin(test['SMILES'])]
    return cross_validate(train_filtered)
```

## 現状の評価と今後の見通し

### 1. 現在のリーダーボード

- **信頼性：低**
- 外部データ利用の解法が上位を占める可能性
- 真の性能は不明

### 2. 最終評価への影響

- Private testは大幅に変更される
- 新規追加データが主要な評価対象となる
- 外部データ依存の解法は不利になる

### 3. 推奨戦略

1. **ベースラインの確立**
   - コンペティションデータのみでの性能確認
   - 汎化性能を重視した特徴量設計

2. **外部データの慎重な使用**
   - ライセンスの確認
   - データの出所の明確化
   - クロスバリデーションでの検証

3. **モデルの解釈性**
   - 予測の根拠を説明可能に
   - 物理化学的な妥当性の確認

## まとめ

このデータリーク問題は、コンペティションの競技性に大きな影響を与えています。主催者は積極的に対応していますが、参加者は以下の点に注意すべきです：

1. 現在のPublic LBスコアを過信しない
2. 外部データの使用は慎重に
3. 汎化性能を重視したモデル開発
4. 新規追加されるテストデータへの対応準備

最終的には、真に汎化性能の高いモデルが評価される方向に調整されることが期待されます。